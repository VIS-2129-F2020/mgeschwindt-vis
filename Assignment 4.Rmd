---
title: "Assignment 5 Isochrones"
author: "Mary Geschwindt"
date: "10/2/2020"
output: 
  html_document:
    theme: paper
    toc: true
    toc_depth: 3
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Assignment Setup

### Libraries

```{r message=FALSE, results='hide'}
library(osmdata)
library(opentripplanner)
library(tidyverse)
library(sf)
library(ggthemes)
library(ggspatial)
library(dplyr)
```

### Topic and Data

For this assignment, I want to look at walksheds and bikesheds for museums in NYC. There are 130 museums in the KML list from NYC Open Data. To stay consistent with this assignment's instructions of selecting 5-30 locations, I will select only museums which I have visited.

```{r message=FALSE, results='hide'}
NYC_museums <- st_read(
  "https://data.cityofnewyork.us/api/geospatial/ekax-ky3z?method=export&format=KML") %>%
  filter(Name %in% c("American Museum of Natural History", "Cloisters", "New Museum of Contemporary Art", "Skyscraper Museum", "Whitney Museum of American Art", "Cooper-Hewitt, National Design Museum", "Fraunces Tavern Museum", "Frick Collection", "Metropolitan Museum of Art (MET)", "Morgan Library and Museum", "Museum of Modern Art (MoMA)", "Museum of the City of New York", "Solomon R. Guggenheim Museum", "Studio Museum in Harlem"))
```

### New York City Geography

```{r}
opq(bbox = 'New York NY USA') %>%
  add_osm_feature(key = 'highway') %>%
  osmdata_xml(file = 'OTP/graphs/default/newyork_streets.osm')
```

```{r}
NY_state_plane <- "+proj=tmerc +lat_0=38.83333333333334 +lon_0=-74.5 +k=0.9999 +x_0=150000 +y_0=0 +ellps=GRS80 +units=m +no_defs"

nyc_street_features <- opq(bbox = 'New York NY USA') %>%
  add_osm_feature(key = 'highway') %>%
  osmdata_sf()

nyc_streets <- nyc_street_features$osm_lines %>%
  st_transform(crs = NY_state_plane)
```

I'll create a test map to make sure the NYC street geometries have been loaded correctly:

```{r fig.height=10, fig.width=10}
ggplot(nyc_streets) +
  geom_sf() +
  theme_map()
```

### OTP Setup

```{r message=FALSE}
path_otp <- otp_dl_jar("OTP")
```

```{r message=FALSE}
path_data <- file.path(getwd(), "OTP")
path_otp <- paste(path_data, "otp.jar",sep = "/")

otp_build_graph(otp = path_otp, dir = path_data, memory = 1024) 
```

```{r message=FALSE}
otp_setup(otp = path_otp, dir = path_data, memory =1024)
```

```{r message=FALSE}
otpcon <- otp_connect()
```

## Figure 1: Isochrone Visualization

Now that I have my data, geography, and OTP setup, I will create an isochrone depicting the 10 minute walkshed and bikeshed around each NYC museum I selected. I'll create several isochrones to test out various aesthetics, but each will depict the same walksheds and bikesheds.

```{r message=FALSE}
iso_10min_walk <- 
  otp_isochrone(otpcon = otpcon, fromPlace = NYC_museums, 
                mode = "WALK", cutoffSec = 600) %>%
  st_transform(crs = NY_state_plane) %>%
  mutate(mode = "walk")

iso_10min_bike <- 
  otp_isochrone(otpcon = otpcon, fromPlace = NYC_museums, 
                mode = "BICYCLE", cutoffSec = 600) %>%
  st_transform(crs = NY_state_plane) %>%
  mutate(mode = "bicycle")

iso_all_modes <- rbind(iso_10min_bike, iso_10min_walk)

otp_stop()
```

### Isochrone 1

```{r fig.height=10, fig.width=10}
right_side <- st_bbox(iso_all_modes)$xmax
left_side  <- st_bbox(iso_all_modes)$xmin
top_side <- st_bbox(iso_all_modes)$ymax
bottom_side <- st_bbox(iso_all_modes)$ymin

ggplot(iso_all_modes) +
  annotation_map_tile(zoomin = 0, type = "cartolight", progress = "none") +
  geom_sf(aes(fill = mode), alpha = 0.5) +
  geom_sf(data = NYC_museums, aes()) +
  coord_sf(xlim = c(left_side, right_side), 
           ylim = c(bottom_side, top_side), expand = FALSE) +
  scale_fill_discrete(name = "Area that is reachable within 10 minutes",
                       labels = c("By bike", "By foot"),
                       type = c("aquamarine1", "slateblue1" )) +
  theme_map() +
    theme(legend.background = element_rect(fill = alpha("white", 0.5), color = "black"),
          legend.position = c(0.08, 0.75),
          legend.key.size = unit(0.3, "cm")) +
  labs(caption = "Basemap Copyright OpenStreetMap contributors")
```

### Isochrone 2

```{r fig.height=10, fig.width=10}
ggplot(iso_all_modes) +
  annotation_map_tile(zoomin = 0, type = "stamenbw", progress = "none") +
  geom_sf(aes(fill = mode), alpha = 0.5) +
  geom_sf(data = NYC_museums) +
  coord_sf(xlim = c(left_side, right_side), 
           ylim = c(bottom_side, top_side), expand = FALSE) +
  scale_fill_discrete(name = "Area that is reachable within 10 minutes",
                       labels = c("By bike", "By foot"),
                       type = c("olivedrab2", "royalblue2")) +
  theme_map() +
      theme(legend.background = element_rect(fill = alpha("white", 0.9), color = "black"),
          legend.position = c(0.08, 0.75),
          legend.key.size = unit(0.3, "cm")) +
  labs(caption = "Basemap Copyright OpenStreetMap contributors")
```

### Isochrone 3

```{r fig.height=10, fig.width=10}
ggplot(iso_all_modes) +
  geom_sf(data = nyc_streets, color = "gray") +
  geom_sf(aes(fill = mode), alpha = 0.5) +
  geom_sf(data = NYC_museums) +
  coord_sf(xlim = c(left_side, right_side), 
           ylim = c(bottom_side, top_side), expand = FALSE) +
  scale_fill_discrete(name = "Area that is reachable within 10 minutes",
                       labels = c("By bike", "By foot"),
                       type = c("gold", "darkorchid")) +

  theme_map() +
    theme(legend.background = element_rect(fill = alpha("white", 0.9), color = "black"),
          legend.position = c(0.08, 0.75),
          legend.key.size = unit(0.3, "cm")) +
  labs(caption = "Basemap Copyright OpenStreetMap contributors")
```

## Calculating and Comparing Isochrones

### Figure 2: Scatterplot

I will create a scatterplot to compare the isochrones showing the 10 minute walkshed vs. bikeshed for the selected museums.

```{r}
iso_areas <- iso_all_modes %>%
  mutate(area = st_area(iso_all_modes)) %>%
  st_set_geometry(NULL) %>%
  pivot_wider(names_from = mode, values_from = area) 

ggplot(iso_areas, 
       aes(x = as.numeric(walk), y = as.numeric(bicycle))) +
  geom_point() +
  stat_smooth(method = "lm") +
  scale_x_continuous(name = 
            "Area within a ten-minute walking distance\nof a museum\n(square km)",
            breaks = breaks <- seq(10000, 130000, by = 20000),
            labels = breaks / 1000000) +
  scale_y_continuous(name = 
            "Area within a ten-minute biking distance\nof a museum\n(square km)",
            breaks = breaks <- seq(0, 700000, by = 100000),
            labels = breaks / 1000000) +
  theme_bw()
```

### Figure 3: Bubble Chart

I want to answer the question: how much greater is the area that a 10 minute bike ride can cover than the area that is covered by a 10 minute walk to a museum? I will create a figure which uses scale and geometry to compare the sizes of these 2 areas.

```{r message=FALSE}

```


### Figure 4: Bar Chart

I will create a bar chart which compares the area covered by a 10 minute bike ride and a 10 minute walk for each museum. My x-axis will be the area, and my y-axis will be the museums.

```{r message=FALSE}

```

## Assignment Conclusion

All of the museums selected in this assignment are located on the island of Manhattan, which has a width of about 2.3 miles at its widest point. From visualizing the 10 minute walksheds and bikesheds around the selected museums, it was interesting to see that often, the bikesheds span the width of the island. The walksheds are considerably smaller compared to the area that is covered under the bikesheds.

I may assume that the reason for bikes being able to cover a much larger area is related to speed. I would imagine that the grid pattern of Manhattan means that both pedestrians and bicyclists have few turns to make before being able to travel along a straight line to their destinations. However, a bicyclist is able to travel much faster than a pedestrian. One piece of information which would be interesting to look at is where the bike lanes are, and understand how bike lane locations can influence bicycle travel time. Because many streets in New York are one-way, this would affect the choices a bicyclist would have in his or her route. On the other hand, a pedestrian is not constrained to walk any certain direction on the sidewalk, and therefore has many more options in where to turn or continue walking straight.

My assumption that speed is the reason for why bikes can cover a much larger area in the 10 minute bikeshed must be further studied by reviewing real-world conditions and pedestrian and bicyclist behaviors. As someone with experience as both a pedestrian and a bicyclist in New York, I know that on-the-ground conditions can influence decisions on where to walk or bike. For example, there may be some roads which provide a more direct route by bike which would take less time, but these routes may not have sufficient protected bike lanes. The lack of sufficient bicycle infrastructure may cause me to opt for a longer route which has better safety conditions.